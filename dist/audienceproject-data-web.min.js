!function(e,t){"function"==typeof define&&define.amd?define("AudienceProjectData",["exports"],t):"undefined"!=typeof exports?t(exports):(t(t={}),e.AudienceProjectData=t)}("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:this,function(e){"use strict";function A(){return(A=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,a=arguments[t];for(n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}e.__esModule=!0,e.default=e.fetch=e.fetchStatus=e.fetchStateFailed=e.fetchStateReady=e.fetchStateRunning=e.fetchStateInitial=e.fetchCache=e.packageVersion=e.packageName=e.moduleName=void 0;var o="AudienceProjectData";e.moduleName=o;var C="@audienceproject/data-web";e.packageName=C;var P="1.0.2";e.packageVersion=P;var R={};e.fetchCache=R;var t="INITIAL";e.fetchStateInitial=t;var n="RUNNING";e.fetchStateRunning=n;var T="READY";e.fetchStateReady=T;var N="FAILED";e.fetchStateFailed=N;var E={state:t};e.fetchStatus=E;var a=function(c,e,t){if("string"!=typeof c||!c)throw new Error("Invalid customer ID");function u(){for(var e,t=arguments.length,n=new Array(t),a=0;a<t;a++)n[a]=arguments[a];return l.debug&&(null==(e=console)?void 0:e.log.apply(e,["["+o+"]"].concat(n)))}var l=A({allowStorageAccess:!0,allowPersonalisation:!0,gdprApplies:null,consentString:"",integrateWithCmp:!1,waitForCmpConsent:!1,requestParams:{},timeout:1e3,addStatusKey:!1,cacheType:"",cacheKey:"url,allowPersonalisation,requestParams",cacheTime:86400,requestDomains:{regular:"pdw-usr.userreport.com",nonPersonalised:"dnt-userreport.com"},debug:!1},e);u("Fetch called…"),u("Version:",P),u("Customer ID:",c),u("Customer options:",e),u("Fetch options:",l);function s(e){try{return JSON.parse(e)}catch(e){return}}function d(e){if(l.allowStorageAccess){var t;try{t=a[e]}catch(e){}return t&&0===t.indexOf("{")&&t.lastIndexOf("}")===t.length-1?s(t):t}}function f(e,t){if(l.allowStorageAccess){var n="object"==typeof t?JSON.stringify(t):t;try{a[e]=n}catch(e){}}}function p(e,t){u("Reading prediction from API…");var i=["med",window.location.href];document.referrer&&i.push("ref",document.referrer);var n=d(m);n&&i.push("sref",n),!l.allowPersonalisation||(n=d("apr_dsu"))&&i.push("dsu",n),"boolean"==typeof l.gdprApplies&&i.push("gdpr",Number(l.gdprApplies)),l.consentString&&i.push("gdpr_consent",l.consentString),i.push("appid",C+":"+P),function a(o,r){Object.keys(o).forEach(function(e){var t=o[e],n=r+e;e=t,"[object Array]"===Object.prototype.toString.call(e)?t.forEach(function(e){i.push(n,e)}):"object"==typeof t?a(t,n+"_"):i.push(n,t)})}(l.requestParams,"");var a,o,r="https://"+(l.allowPersonalisation?l.requestDomains.regular:l.requestDomains.nonPersonalised)+"/api/v2/partner/"+encodeURIComponent(c)+"/uid";return i.forEach(function(e,t){r+=(t%2?"=":t?"&":"?")+encodeURIComponent(e)}),a=e,o=t,u("API request:",t=r),w.onreadystatechange=function(){var e;w.readyState===XMLHttpRequest.DONE&&(200===w.status?(e=s(w.responseText),u("API response:",e),a(e)):(u("API failed with code:",w.status),o()))},w.open("GET",t,!0),w.withCredentials=l.allowPersonalisation,void w.send()}var h,g=function(e){for(var t=0,n=e.length,a=0;a<n;a+=1)t=(t<<5)-t+e.charCodeAt(a),t&=t;return t}(l.cacheKey.split(",").sort().map(function(e){if("url"===e)return window.location.pathname.slice(1)+window.location.search;if("allowPersonalisation"===e)return l.allowPersonalisation?"":0;if("requestParams"!==e)return"";e=JSON.stringify(l.requestParams);return"{}"===e?"":e}).join("")),a=localStorage,m="apr_sref",v="apr_data_cache",y=Math.round((new Date).getTime()/1e3),S="localStorage"!==l.cacheType||function(){if(!l.allowStorageAccess)return!1;var e="apr_check_access@"+Math.random();try{a[e]=e;var t=a[e]===e;return delete a[e],t}catch(e){}return!1}()?l.cacheType:"memory",w=new XMLHttpRequest,i=[];return"function"==typeof t&&i.push(t),function(){var c;function s(e,t){var n,a,o;r||(r=!0,n=e,a=t.code,l.addStatusKey&&(u("Updating status fields…"),n.keyValues=n.keyValues||{},n.keyValues.ap_ds=String(a)),o=A({type:t.value},e),E.state=0<t.code?T:N,E.result=o,E.options=l,t=c,clearTimeout(t),t=(new Date).getTime()-h,u("Timeout ended:",t,"ms"),w.abort(),u("Callback result:",o),i.forEach(function(e){e(o)}))}E.state=n,delete E.result,delete E.options;var r=!1;!function(n){if(l.integrateWithCmp){if(u("Checking CMP…"),"function"!=typeof __tcfapi)return u("No TCF 2.0 API found…"),n();u("Using TCF 2.0 API…");var a=function(e){var t,n,a,o;l.gdprApplies=Boolean(e.gdprApplies),l.consentString=e.tcString||"",l.gdprApplies&&(o=null==(o=e.vendor)||null==(t=o.consents)?void 0:t[394],l.allowStorageAccess=Boolean(o&&(null==(t=e.purpose)||null==(n=t.consents)?void 0:n[1])),l.allowPersonalisation=Boolean(o&&(null==(e=e.purpose)||null==(a=e.consents)?void 0:a[3]))),u("Options after CMP override:",l)},o=function(e,a){__tcfapi(e,2,function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];u.apply(void 0,["TCF response:"].concat(t)),a.apply(void 0,t)},[394])},t=function e(t){t.tcString&&(o("removeEventListener",e),a(t),n())};o("getTCData",function(e){if(!l.waitForCmpConsent||!e.gdprApplies||e.tcString)return a(e),void n();u("Adding TCF consent listener…"),o("addEventListener",t)})}else n()}(function(){var e,t,n,a={value:"TIMEOUT",code:-2},o={value:"BACKEND_ERROR",code:-1},r=l.allowPersonalisation?{value:"RETURNED",code:1}:{value:"RETURNED_ANONYMOUS",code:"1a"},i=l.allowPersonalisation?{value:"RETURNED_FROM_CACHE",code:2}:{value:"RETURNED_ANONYMOUS_FROM_CACHE",code:"2a"};return c=function(e){if(l.timeout)return u("Timeout started…"),h=(new Date).getTime(),setTimeout(e,l.timeout)}(function(){s({},a)}),l.allowPersonalisation&&(u("Checking session referrer…"),t=window.location.protocol+"//"+window.location.host+"/",document.referrer&&0!==document.referrer.indexOf(t)&&(u("Session referrer updated:",document.referrer),f(m,document.referrer))),e=function(e){s(e,i)},t=function(){return p(function(e){var t;t=e,S&&(u("Saving prediction to cache…"),t={data:t,ttl:y,hash:g},"localStorage"===S?f(v,t):"memory"===S&&(R[g]=t)),s(e,r)},function(){s({},o)})},S?(u("Reading prediction from cache…"),"localStorage"===S?(u("Reading prediction from local storage key:",v),n=d(v)):"memory"===S&&(u("Reading prediction from memory key:",g),n=R[g]),"object"!=typeof n?t():n.ttl+l.cacheTime<y||n.hash!==g?(u("Cached prediction expired…"),t()):(u("Cached prediction:",n.data),e(n.data))):t()})}(),{promise:function(){return new Promise(function(e){u("Promise called…"),i.push(e)})}}};e.fetch=a;a={moduleName:o,packageName:C,packageVersion:P,fetchCache:R,fetchStateInitial:t,fetchStateRunning:n,fetchStateReady:T,fetchStateFailed:N,fetchStatus:E,fetch:a};e.default=a});