!function(e,t){"function"==typeof define&&define.amd?define("AudienceProjectData",["exports"],t):"undefined"!=typeof exports?t(exports):(t(t={}),e.AudienceProjectData=t)}("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:this,function(e){"use strict";function T(){return(T=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,a=arguments[t];for(n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}e.__esModule=!0,e.default=e.fetch=e.fetchStatus=e.fetchStateFailed=e.fetchStateReady=e.fetchStateRunning=e.fetchStateInitial=e.fetchCache=e.packageVersion=e.packageName=e.moduleName=void 0;var r="AudienceProjectData";e.moduleName=r;var N="@audienceproject/data-web";e.packageName=N;var E="1.0.2";e.packageVersion=E;var _={};e.fetchCache=_;var t="INITIAL";e.fetchStateInitial=t;var n="RUNNING";e.fetchStateRunning=n;var I="READY";e.fetchStateReady=I;var O="FAILED";e.fetchStateFailed=O;var D={state:t};e.fetchStatus=D;var a=function(c,e,t){if("string"!=typeof c||!c)throw new Error("Invalid customer ID");function s(){for(var e,t=arguments.length,n=new Array(t),a=0;a<t;a++)n[a]=arguments[a];return u.debug&&(null==(e=console)?void 0:e.log.apply(e,["["+r+"]"].concat(n)))}var u=T({allowStorageAccess:!0,allowPersonalisation:!0,gdprApplies:null,consentString:"",integrateWithCmp:!1,waitForCmpConsent:!1,requestParams:{},timeout:1e3,addStatusKey:!1,cacheType:"",cacheKey:"url,allowPersonalisation,requestParams",cacheTime:86400,requestDomains:{regular:"pdw-usr.userreport.com",nonPersonalised:"dnt-userreport.com"},debug:!1},e);s("Fetch called…"),s("Version:",E),s("Customer ID:",c),s("Customer options:",e),s("Fetch options:",u);function l(e){try{return JSON.parse(e)}catch(e){return}}function d(e){if(u.allowStorageAccess){var t;try{t=a[e]}catch(e){}return t&&0===t.indexOf("{")&&t.lastIndexOf("}")===t.length-1?l(t):t}}function o(e,t){if(u.allowStorageAccess){var n="object"==typeof t?JSON.stringify(t):t;try{a[e]=n}catch(e){}}}function f(e,t){s("Reading prediction from API…");var i=["med",window.location.href];document.referrer&&i.push("ref",document.referrer);var n=d(g);n&&i.push("sref",n),!u.allowPersonalisation||(n=d("apr_dsu"))&&i.push("dsu",n),"boolean"==typeof u.gdprApplies&&i.push("gdpr",Number(u.gdprApplies)),u.consentString&&i.push("gdpr_consent",u.consentString),i.push("appid",N+":"+E),function a(o,r){Object.keys(o).forEach(function(e){var t=o[e],n=r+e;e=t,"[object Array]"===Object.prototype.toString.call(e)?t.forEach(function(e){i.push(n,e)}):"object"==typeof t?a(t,n+"_"):i.push(n,t)})}(u.requestParams,"");var a,o,r="https://"+(u.allowPersonalisation?u.requestDomains.regular:u.requestDomains.nonPersonalised)+"/api/v2/partner/"+encodeURIComponent(c)+"/uid";return i.forEach(function(e,t){r+=(t%2?"=":t?"&":"?")+encodeURIComponent(e)}),a=e,o=t,s("API request:",t=r),P.onreadystatechange=function(){var e;P.readyState===XMLHttpRequest.DONE&&(200===P.status?(e=l(P.responseText),s("API response:",e),a(e)):(s("API failed with code:",P.status),o()))},P.open("GET",t,!0),P.withCredentials=u.allowPersonalisation,void P.send()}var p,h=function(e){for(var t=0,n=e.length,a=0;a<n;a+=1)t=(t<<5)-t+e.charCodeAt(a),t&=t;return t}(u.cacheKey.split(",").sort().map(function(e){if("url"===e)return window.location.pathname.slice(1)+window.location.search;if("allowPersonalisation"===e)return u.allowPersonalisation?"":0;if("requestParams"!==e)return"";e=JSON.stringify(u.requestParams);return"{}"===e?"":e}).join("")),a=localStorage,g="apr_sref",m="apr_data_cache",v=Math.round((new Date).getTime()/1e3),y="localStorage"!==u.cacheType||function(){if(!u.allowStorageAccess)return!1;var e="apr_check_access@"+Math.random();try{a[e]=e;var t=a[e]===e;return delete a[e],t}catch(e){}return!1}()?u.cacheType:"memory",S={value:"TIMEOUT",code:-2},w={value:"BACKEND_ERROR",code:-1},A=u.allowPersonalisation?{value:"RETURNED",code:1}:{value:"RETURNED_ANONYMOUS",code:"1a"},C=u.allowPersonalisation?{value:"RETURNED_FROM_CACHE",code:2}:{value:"RETURNED_ANONYMOUS_FROM_CACHE",code:"2a"},P=new XMLHttpRequest,R=[];return"function"==typeof t&&R.push(t),function(){var r;function a(e,t){var n,a,o;i||(i=!0,n=e,a=t.code,u.addStatusKey&&(s("Updating status fields…"),n.keyValues=n.keyValues||{},n.keyValues.ap_ds=String(a)),o=T({type:t.value},e),D.state=0<t.code?I:O,D.result=o,D.options=u,t=r,clearTimeout(t),t=(new Date).getTime()-p,s("Timeout ended:",t,"ms"),P.abort(),s("Callback result:",o),R.forEach(function(e){e(o)}))}D.state=n,delete D.result,delete D.options;var i=!1;!function(n){if(u.integrateWithCmp){if(s("Checking CMP…"),"function"!=typeof __tcfapi)return s("No TCF 2.0 API found…"),n();s("Using TCF 2.0 API…");var a=function(e){var t,n,a,o;u.gdprApplies=Boolean(e.gdprApplies),u.consentString=e.tcString||"",u.gdprApplies&&(o=null==(o=e.vendor)||null==(t=o.consents)?void 0:t[394],u.allowStorageAccess=Boolean(o&&(null==(t=e.purpose)||null==(n=t.consents)?void 0:n[1])),u.allowPersonalisation=Boolean(o&&(null==(e=e.purpose)||null==(a=e.consents)?void 0:a[3]))),s("Options after CMP override:",u)},o=function(e,a){__tcfapi(e,2,function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];s.apply(void 0,["TCF response:"].concat(t)),a.apply(void 0,t)},[394])},t=function e(t){t.tcString&&(o("removeEventListener",e),a(t),n())};o("getTCData",function(e){if(!u.waitForCmpConsent||!e.gdprApplies||e.tcString)return a(e),void n();s("Adding TCF consent listener…"),o("addEventListener",t)})}else n()}(function(){var e,t,n;return r=function(e){if(u.timeout)return s("Timeout started…"),p=(new Date).getTime(),setTimeout(e,u.timeout)}(function(){a({},S)}),u.allowPersonalisation&&(s("Checking session referrer…"),t=window.location.protocol+"//"+window.location.host+"/",document.referrer&&0!==document.referrer.indexOf(t)&&(s("Session referrer updated:",document.referrer),o(g,document.referrer))),e=function(e){a(e,C)},t=function(){return f(function(e){var t;t=e,y&&(s("Saving prediction to cache…"),t={data:t,ttl:v,hash:h},"localStorage"===y?o(m,t):"memory"===y&&(_[h]=t)),a(e,A)},function(){a({},w)})},y?(s("Reading prediction from cache…"),"localStorage"===y?(s("Reading prediction from local storage key:",m),n=d(m)):"memory"===y&&(s("Reading prediction from memory key:",h),n=_[h]),"object"!=typeof n?t():n.ttl+u.cacheTime<v||n.hash!==h?(s("Cached prediction expired…"),t()):(s("Cached prediction:",n.data),e(n.data))):t()})}(),{promise:function(){return new Promise(function(e){s("Promise called…"),R.push(e)})}}};e.fetch=a;a={moduleName:r,packageName:N,packageVersion:E,fetchCache:_,fetchStateInitial:t,fetchStateRunning:n,fetchStateReady:I,fetchStateFailed:O,fetchStatus:D,fetch:a};e.default=a});