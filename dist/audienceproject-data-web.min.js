!function(e,t){"function"==typeof define&&define.amd?define("AudienceProjectData",["exports"],t):"undefined"!=typeof exports?t(exports):(t(t={}),e.AudienceProjectData=t)}("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:this,function(A){"use strict";function P(){return(P=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,o=arguments[t];for(n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])}return e}).apply(this,arguments)}A.__esModule=!0,A.default=A.fetch=A.fetchStatus=A.packageVersion=A.packageName=A.moduleName=void 0;var i="AudienceProjectData";A.moduleName=i;var C="@audienceproject/data-web";A.packageName=C;var R="1.0.0";A.packageVersion=R;var N={},E="FAILED",T={state:E};A.fetchStatus=T;var e=function(r,e,t){if("string"!=typeof r)throw new Error("Invalid customer ID");function s(){for(var e,t=arguments.length,n=new Array(t),o=0;o<t;o++)n[o]=arguments[o];return c.debug&&(null==(e=console)?void 0:e.log.apply(e,["["+i+"]"].concat(n)))}var c=P({allowStorageAccess:!0,allowPersonalisation:!0,gdprApplies:null,consentString:"",integrateWithCmp:!1,waitForCmpConsent:!1,requestParams:{},timeout:1e3,addStatusKey:!1,cacheType:"",cacheKey:"url,allowPersonalisation,requestParams",cacheTime:86400,requestDomains:{regular:"pdw-usr.userreport.com",nonPersonalised:"dnt-userreport.com"},debug:!1},e);s("Version:",R),s("Customer ID:",r),s("Options:",c);function a(e){try{return JSON.parse(e)}catch(e){return}}function u(e){if(c.allowStorageAccess){var t;try{t=o[e]}catch(e){}return t&&0===t.indexOf("{")&&t.lastIndexOf("}")===t.length-1?a(t):t}}function l(e,t){if(c.allowStorageAccess){var n="object"==typeof t?JSON.stringify(t):t;try{o[e]=n}catch(e){}}}function p(e,t){s("Reading prediction from API…");var i=["med",window.location.href];document.referrer&&i.push("ref",document.referrer);var n=u(f);n&&i.push("sref",n),!c.allowPersonalisation||(n=u("apr_dsu"))&&i.push("dsu",n),"boolean"==typeof c.gdprApplies&&i.push("gdpr",Number(c.gdprApplies)),c.consentString&&i.push("gdpr_consent",c.consentString),i.push("appid",C+":"+R),function o(r,a){Object.keys(r).forEach(function(e){var t=r[e],n=a+e;e=t,"[object Array]"===Object.prototype.toString.call(e)?t.forEach(function(e){i.push(n,e)}):"object"==typeof t?o(t,n+"_"):i.push(n,t)})}(c.requestParams,"");var o="https://"+(c.allowPersonalisation?c.requestDomains.regular:c.requestDomains.nonPersonalised)+"/api/v2/partner/"+encodeURIComponent(r)+"/uid";return i.forEach(function(e,t){o+=(t%2?"=":t?"&":"?")+encodeURIComponent(e)}),function(e,t,n){s("Fetching URL:",e);var o=new XMLHttpRequest;o.onreadystatechange=function(){var e;o.readyState===XMLHttpRequest.DONE&&(200===o.status?(e=a(o.responseText),s("Response succeed",e),t(e)):(s("Response failed:",o),n()))},o.open("GET",e,!0),o.withCredentials=c.allowPersonalisation,o.send()}(o,e,t)}var d=function(e){for(var t=0,n=e.length,o=0;o<n;o+=1)t=(t<<5)-t+e.charCodeAt(o),t&=t;return t}(c.cacheKey.split(",").sort().map(function(e){if("url"===e)return window.location.pathname.slice(1)+window.location.search;if("allowPersonalisation"===e)return c.allowPersonalisation?"":0;if("requestParams"!==e)return"";e=JSON.stringify(c.requestParams);return"{}"===e?"":e}).join("")),o=localStorage,f="apr_sref",g="apr_data_cache",h=Math.round((new Date).getTime()/1e3),m="localStorage"!==c.cacheType||c.allowStorageAccess?c.cacheType:"memory",v={value:"TIMEOUT",code:-2},y={value:"BACKEND_ERROR",code:-1},w=c.allowPersonalisation?{value:"RETURNED",code:1}:{value:"RETURNED_ANONYMOUS",code:"1a"},S=c.allowPersonalisation?{value:"RETURNED_FROM_CACHE",code:2}:{value:"RETURNED_ANONYMOUS_FROM_CACHE",code:"2a"};s("Running promise…");function n(r){var a,i=!1;function o(e,t){var n,o;i||(i=!0,clearTimeout(a),n=e,o=t.code,c.addStatusKey&&(s("Updating status fields…"),n.keyValues=n.keyValues||{},n.keyValues.ap_ds=o),A.fetchStatus=T={state:0<t.code?"READY":E,options:c,result:P({type:S.value},e)},r(e))}A.fetchStatus=T={state:"RUNNING"},function(n){if(c.integrateWithCmp){if(s("Checking CMP…"),"function"!=typeof __tcfapi)return s("No TCF 2.0 API found…"),n();s("Using TCF 2.0 API…");var o=function(e){var t,n,o,r;c.gdprApplies=Boolean(e.gdprApplies),c.consentString=e.tcString||"",c.gdprApplies&&(r=null==(r=e.vendors)||null==(t=r.consents)?void 0:t[394],c.allowStorageAccess=Boolean(r&&(null==(t=e.purpose)||null==(n=t.consents)?void 0:n[1])),c.allowPersonalisation=Boolean(r&&(null==(e=e.purpose)||null==(o=e.consents)?void 0:o[3]))),s("Options after CMP override:",c)},r=function(e,o){__tcfapi(e,2,function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];s.apply(void 0,["TCF response:"].concat(t)),o.apply(void 0,t)},[394])},t=function e(t){t.tcString&&(r("removeEventListener",e),o(t),n())};r("getTCData",function(e){if(!c.waitForCmpConsent||!e.gdprApplies||e.tcString)return o(e),void n();s("Adding TCF consent listener…"),r("addEventListener",t)})}else n()}(function(){var e,t,n;return a=function(e){if(c.timeout)return s("Starting reject timeout…"),setTimeout(e,c.timeout)}(function(){o({},v)}),c.allowPersonalisation&&(s("Checking session referrer…"),t=window.location.protocol+"//"+window.location.host+"/",document.referrer&&0!==document.referrer.indexOf(t)&&(s("Session referrer updated:",document.referrer),l(f,document.referrer))),e=function(e){o(e,S)},t=function(){return p(function(e){var t;t=e,m&&(s("Saving prediction to cache…"),t={data:t,ttl:c.cacheTime+h,hash:d},"localStorage"===m?l(g,t):"memory"===m&&(N[d]=t)),o(e,w)},function(){o({},y)})},m?(s("Reading prediction from cache…"),"localStorage"===m?(s("Reading prediction from local storage key:",g),n=u(g)):"memory"===m&&(s("Reading prediction from memory key:",d),n=N[d]),"object"!=typeof n?t():n.ttl<h||n.hash!==d?(s("Cached prediction expired…"),t()):(s("Cached prediction:",n.data),e(n.data))):t()})}return"function"==typeof t?n(t):{promise:function(){return new Promise(n)}}};A.fetch=e;e={moduleName:i,packageName:C,packageVersion:R,fetch:e,fetchStatus:T};A.default=e});