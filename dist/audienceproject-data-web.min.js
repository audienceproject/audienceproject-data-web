!function(e,t){"function"==typeof define&&define.amd?define("AudienceProjectData",["exports"],t):"undefined"!=typeof exports?t(exports):(t(t={}),e.AudienceProjectData=t)}("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:this,function(e){"use strict";function C(){return(C=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,a=arguments[t];for(n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}e.__esModule=!0,e.default=e.fetch=e.fetchStatus=e.fetchStateFailed=e.fetchStateReady=e.fetchStateRunning=e.fetchStateInitial=e.fetchCache=e.packageVersion=e.packageName=e.moduleName=void 0;var i="AudienceProjectData";e.moduleName=i;var P="@audienceproject/data-web";e.packageName=P;var R="1.0.5";e.packageVersion=R;var T={};e.fetchCache=T;var t="INITIAL";e.fetchStateInitial=t;var n="RUNNING";e.fetchStateRunning=n;var N="READY";e.fetchStateReady=N;var E="FAILED";e.fetchStateFailed=E;var O={state:t};e.fetchStatus=O;var a=function(c,e,t){if("string"!=typeof c||!c)throw new Error("Invalid customer ID");function s(){for(var e,t=arguments.length,n=new Array(t),a=0;a<t;a++)n[a]=arguments[a];return u.debug&&(null==(e=console)?void 0:e.log.apply(e,["["+i+"]"].concat(n)))}var a,r,u=C({allowStorageAccess:!0,allowPersonalisation:!0,gdprApplies:null,consentString:"",integrateWithCmp:!1,waitForCmpConsent:!1,requestParams:{},timeout:1e3,addStatusKey:!1,cacheType:"",cacheKey:"url,allowPersonalisation,requestParams",cacheTime:86400,requestDomains:{regular:"pdw-usr.userreport.com",nonPersonalised:"dnt-userreport.com"},debug:!1},e,(r="__audienceProjectDataFetchOptions=",window.location.search.split(/[?&]/).some(function(e){var t=0===e.indexOf(r);if(t){var n=e.slice(r.length);try{a=JSON.parse(decodeURIComponent(n))}catch(e){}}return t}),a));s("Fetch called…"),s("Version:",R),s("Customer ID:",c),s("Customer options:",e),s("Fetch options:",u);function l(e){try{return JSON.parse(e)}catch(e){return}}function d(){return function(e){for(var t=0,n=e.length,a=0;a<n;a+=1)t=(t<<5)-t+e.charCodeAt(a),t&=t;return t}(u.cacheKey.split(/\s*,\s*/).sort().map(function(e){if("url"===e)return window.location.pathname.slice(1)+window.location.search;if("allowPersonalisation"===e)return u.allowPersonalisation?"":0;if("requestParams"!==e)return"";e=JSON.stringify(u.requestParams);return"{}"===e?"":e}).join(""))}function f(e){if(u.allowStorageAccess){var t;try{t=o[e]}catch(e){}return t&&0===t.indexOf("{")&&t.lastIndexOf("}")===t.length-1?l(t):t}}function p(e,t){if(u.allowStorageAccess){var n="object"==typeof t?JSON.stringify(t):t;try{o[e]=n}catch(e){}}}function h(){return"localStorage"!==u.cacheType||function(){if(!u.allowStorageAccess)return!1;var e="apr_check_access@"+Math.random();try{o[e]=e;var t=o[e]===e;return delete o[e],t}catch(e){}return!1}()?u.cacheType:"memory"}function g(e,t){s("Reading prediction from API…");var i=["med",window.location.href];document.referrer&&i.push("ref",document.referrer);var n=f(v);n&&i.push("sref",n),!u.allowPersonalisation||(n=f("apr_dsu"))&&i.push("dsu",n),"boolean"==typeof u.gdprApplies&&i.push("gdpr",Number(u.gdprApplies)),u.consentString&&i.push("gdpr_consent",u.consentString),i.push("appid",P+":"+R),function a(r,o){Object.keys(r).forEach(function(e){var t,n=r[e];void 0!==n&&(t=o+e,e=n,"[object Array]"===Object.prototype.toString.call(e)?n.forEach(function(e){i.push(t,e)}):"object"==typeof n?a(n,t+"_"):i.push(t,n))})}(u.requestParams,"");var a,r,o="https://"+(u.allowPersonalisation?u.requestDomains.regular:u.requestDomains.nonPersonalised)+"/api/v2/partner/"+encodeURIComponent(c)+"/uid";i.forEach(function(e,t){o+=(t%2?"=":t?"&":"?")+encodeURIComponent(e)}),a=e,r=t,s("API request:",t=o),S.onreadystatechange=function(){var e;S.readyState===XMLHttpRequest.DONE&&(200===S.status?(e=l(S.responseText),s("API response:",e),a(e)):(s("API failed with code:",S.status),r()))},S.open("GET",t,!0),S.withCredentials=u.allowPersonalisation,S.send()}var m,o=localStorage,v="apr_sref",y="apr_data_cache",w=Math.round((new Date).getTime()/1e3),S=new XMLHttpRequest,A=[];return"function"==typeof t&&A.push(t),function(){var o;function i(e,t){var n,a,r;c||(c=!0,n=e,a=t.code,u.addStatusKey&&(s("Updating status fields…"),n.keyValues=n.keyValues||{},n.keyValues.ap_ds=String(a)),r=C({type:t.value},e),O.state=0<t.code?N:E,O.result=r,O.options=u,t=o,clearTimeout(t),t=(new Date).getTime()-m,s("Timeout ended:",t,"ms"),S.abort(),s("Callback result:",r),A.forEach(function(e){e(r)}))}O.state=n,delete O.result,delete O.options;var c=!1;!function(n){if(u.integrateWithCmp){if(s("Checking CMP…"),"function"!=typeof __tcfapi)return s("No TCF 2.0 API found…"),n();s("Using TCF 2.0 API…");var a=function(e){var t,n,a,r;u.gdprApplies=Boolean(e.gdprApplies),u.consentString=e.tcString||"",u.gdprApplies&&(r=null==(r=e.vendor)||null==(t=r.consents)?void 0:t[394],u.allowStorageAccess=Boolean(r&&(null==(t=e.purpose)||null==(n=t.consents)?void 0:n[1])),u.allowPersonalisation=Boolean(r&&(null==(e=e.purpose)||null==(a=e.consents)?void 0:a[3]))),s("Options after CMP override:",u)},r=function(e,a){__tcfapi(e,2,function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];s.apply(void 0,["TCF response:"].concat(t)),a.apply(void 0,t)},[394])},t=function e(t){t.tcString&&(r("removeEventListener",e),a(t),n())};r("getTCData",function(e){if(!u.waitForCmpConsent||!e.gdprApplies||e.tcString)return a(e),void n();s("Adding TCF consent listener…"),r("addEventListener",t)})}else n()}(function(){var e,t={value:"TIMEOUT",code:-2},n={value:"BACKEND_ERROR",code:-1},r=u.allowPersonalisation?{value:"RETURNED",code:1}:{value:"RETURNED_ANONYMOUS",code:"1a"},a=u.allowPersonalisation?{value:"RETURNED_FROM_CACHE",code:2}:{value:"RETURNED_ANONYMOUS_FROM_CACHE",code:"2a"};return o=function(e){if(u.timeout)return s("Timeout started…"),m=(new Date).getTime(),setTimeout(e,u.timeout)}(function(){i({},t)}),u.allowPersonalisation&&(s("Checking session referrer…"),e=window.location.protocol+"//"+window.location.host+"/",document.referrer&&0!==document.referrer.indexOf(e)&&(s("Session referrer updated:",document.referrer),p(v,document.referrer))),function(e,t){var n,a=h();if(!a)return t();s("Reading prediction from cache…");var r=d();return"localStorage"===a?(s("Reading prediction from local storage key:",r),n=f(y)):"memory"===a&&(s("Reading prediction from memory key:",r),n=T[r]),"object"!=typeof n?t():n.ttl+u.cacheTime<w||n.hash!==r?(s("Cached prediction expired…"),t()):(s("Cached prediction:",n.data),e(n.data))}(function(e){i(e,a)},function(){return g(function(e){var t,n,a;t=e,(a=h())&&(s("Saving prediction to cache…"),n=d(),t={data:t,ttl:w,hash:n},"localStorage"===a?p(y,t):"memory"===a&&(T[n]=t)),i(e,r)},function(){i({},n)})})})}(),{promise:function(){return new Promise(function(e){s("Promise called…"),A.push(e)})}}};e.fetch=a;a={moduleName:i,packageName:P,packageVersion:R,fetchCache:T,fetchStateInitial:t,fetchStateRunning:n,fetchStateReady:N,fetchStateFailed:E,fetchStatus:O,fetch:a};e.default=a});