!function(e,t){"function"==typeof define&&define.amd?define("AudienceProjectData",["exports"],t):"undefined"!=typeof exports?t(exports):(t(t={}),e.AudienceProjectData=t)}("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:this,function(e){"use strict";function P(){return(P=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,o=arguments[t];for(n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])}return e}).apply(this,arguments)}e.__esModule=!0,e.utils=e.packageVersion=e.packageName=e.moduleName=e.fetchStatus=e.fetchStateRunning=e.fetchStateReady=e.fetchStateInitial=e.fetchStateFailed=e.fetchCache=e.fetch=e.default=void 0;var C="AudienceProjectData";e.moduleName=C;var T="@audienceproject/data-web";e.packageName=T;var R="1.1.1";e.packageVersion=R;var N={};e.fetchCache=N;var t="INITIAL";e.fetchStateInitial=t;var E="RUNNING";e.fetchStateRunning=E;var O="READY";e.fetchStateReady=O;var _="FAILED";e.fetchStateFailed=_;var D={state:t};e.fetchStatus=D;function n(a,e,t){if("string"!=typeof a||!a)throw new Error("Invalid customer ID");var n,o,s=P({allowStorageAccess:!0,allowPersonalisation:!0,gdprApplies:null,consentString:"",integrateWithCmp:!1,waitForCmpConsent:!1,requestParams:{},timeout:1e3,addStatusKey:!1,cacheType:"",cacheKey:"url,allowPersonalisation,requestParams",cacheTime:86400,requestDomains:{regular:"pdw-usr.userreport.com",nonPersonalised:"dnt-userreport.com"},debug:!1},e,(o="__audienceProjectDataFetchOptions=",window.location.search.split(/[?&]/).some(function(e){var t=0===e.indexOf(o);if(t){e=e.slice(o.length);try{n=JSON.parse(decodeURIComponent(e))}catch(e){}}return t}),n)),u=function(){for(var e,t=arguments.length,n=new Array(t),o=0;o<t;o++)n[o]=arguments[o];return s.debug&&(null==(e=console)?void 0:e.log.apply(e,["["+C+"]"].concat(n)))};function r(e){try{return JSON.parse(e)}catch(e){return}}function l(e,t){u("Reading prediction from API…");var i=["med",window.location.href];document.referrer&&i.push("ref",document.referrer);var n=g(p);n&&i.push("sref",n),!s.allowPersonalisation||(n=g(c))&&i.push("dsu",n),"boolean"==typeof s.gdprApplies&&i.push("gdpr",Number(s.gdprApplies)),s.consentString&&i.push("gdpr_consent",s.consentString),i.push("appid",T+":"+R),function o(a,r){Object.keys(a).forEach(function(e){var t,n=a[e];void 0!==n&&(t=r+e,"[object Array]"===Object.prototype.toString.call(n)?n.forEach(function(e){i.push(t,e)}):"object"==typeof n?o(n,t+"_"):i.push(t,n))})}(s.requestParams,"");var o="https://"+(s.allowPersonalisation?s.requestDomains.regular:s.requestDomains.nonPersonalised)+"/api/v2/partner/"+encodeURIComponent(a)+"/uid";return i.forEach(function(e,t){o+=(t%2?"=":t?"&":"?")+encodeURIComponent(e)}),S(o,e,t)}u("Fetch called…"),u("Version:",R),u("Customer ID:",a),u("Customer options:",e),u("Fetch options:",s);var d,f=function(){return function(e){for(var t=0,n=e.length,o=0;o<n;o+=1)t=(t<<5)-t+e.charCodeAt(o),t&=t;return t}(s.cacheKey.split(/\s*,\s*/).sort().map(function(e){if("url"===e)return window.location.pathname.slice(1)+window.location.search;if("allowPersonalisation"===e)return s.allowPersonalisation?"":0;if("requestParams"!==e)return"";e=JSON.stringify(s.requestParams);return"{}"===e?"":e}).join(""))},i=localStorage,p="apr_sref",h="apr_data_cache",c="apr_dsu",g=function(e){if(s.allowStorageAccess){var t;try{t=i[e]}catch(e){}return t&&0===t.indexOf("{")&&t.lastIndexOf("}")===t.length-1?r(t):t}},m=function(e,t){if(s.allowStorageAccess){t="object"==typeof t?JSON.stringify(t):t;try{i[e]=t}catch(e){}}},v=Math.round((new Date).getTime()/1e3),y=function(){return"localStorage"!==s.cacheType||function(){if(!s.allowStorageAccess)return!1;var e="apr_check_access@"+Math.random();try{i[e]=e;var t=i[e]===e;return delete i[e],t}catch(e){}return!1}()?s.cacheType:"memory"},w=new XMLHttpRequest,S=function(e,t,n){u("API request:",e),w.onreadystatechange=function(){var e;w.readyState===XMLHttpRequest.DONE&&(200===w.status?(e=r(w.responseText),u("API response:",e),t(e)):(u("API failed with code:",w.status),n()))},w.open("GET",e,!0),w.withCredentials=s.allowPersonalisation,w.send()},A=[];return"function"==typeof t&&A.push(t),function(){var r;D.state=E,delete D.result,delete D.options;function i(e,t){var n,o,a;c||(c=!0,n=e,o=t.code,s.addStatusKey&&(u("Updating status fields…"),n.keyValues=n.keyValues||{},n.keyValues.ap_ds=String(o)),a=P({type:t.value},e),D.state=0<t.code?O:_,D.result=a,D.options=s,function(e){clearTimeout(e);e=(new Date).getTime()-d;u("Timeout ended:",e,"ms")}(r),w.abort(),u("Callback result:",a),A.forEach(function(e){e(a)}))}var c=!1;!function(n){if(s.integrateWithCmp){if(u("Checking CMP…"),"function"!=typeof __tcfapi)return u("No TCF 2.0 API found…"),n();u("Using TCF 2.0 API…");var r=394,o=function(e){var t,n,o,a;s.gdprApplies=Boolean(e.gdprApplies),s.consentString=e.tcString||"",s.gdprApplies&&(a=null==(a=e.vendor)||null==(t=a.consents)?void 0:t[r],s.allowStorageAccess=Boolean(a&&(null==(t=e.purpose)||null==(n=t.consents)?void 0:n[1])),s.allowPersonalisation=Boolean(a&&(null==(e=e.purpose)||null==(o=e.consents)?void 0:o[3]))),u("Options after CMP override:",s)},a=function(e,o){__tcfapi(e,2,function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];u.apply(void 0,["TCF response:"].concat(t)),o.apply(void 0,t)},[r])},t=function e(t){"tcloaded"!==t.eventStatus&&"useractioncomplete"!==t.eventStatus||(a("removeEventListener",e),o(t),n())};a("getTCData",function(e){if(!s.waitForCmpConsent||!e.gdprApplies||"tcloaded"===e.eventStatus||"useractioncomplete"===e.eventStatus)return o(e),void n();u("Adding TCF consent listener…"),a("addEventListener",t)})}else n()}(function(){var e,t={value:"TIMEOUT",code:-2},n={value:"BACKEND_ERROR",code:-1},a=s.allowPersonalisation?{value:"RETURNED",code:1}:{value:"RETURNED_ANONYMOUS",code:"1a"},o=s.allowPersonalisation?{value:"RETURNED_FROM_CACHE",code:2}:{value:"RETURNED_ANONYMOUS_FROM_CACHE",code:"2a"};return r=function(e){if(s.timeout)return u("Timeout started…"),d=(new Date).getTime(),setTimeout(e,s.timeout)}(function(){i({},t)}),s.allowPersonalisation&&(u("Checking session referrer…"),e=window.location.protocol+"//"+window.location.host+"/",document.referrer&&0!==document.referrer.indexOf(e)&&(u("Session referrer updated:",document.referrer),m(p,document.referrer))),function(e,t){var n,o=y();if(!o)return t();u("Reading prediction from cache…");var a=f();return"localStorage"===o?(u("Reading prediction from local storage key:",a),n=g(h)):"memory"===o&&(u("Reading prediction from memory key:",a),n=N[a]),"object"!=typeof n?t():n.ttl+s.cacheTime<v||n.hash!==a?(u("Cached prediction expired…"),t()):(u("Cached prediction:",n.data),e(n.data))}(function(e){i(e,o)},function(){return l(function(e){var t,n,o;t=e,(o=y())&&(u("Saving prediction to cache…"),n=f(),t={data:t,ttl:v,hash:n},"localStorage"===o?m(h,t):"memory"===o&&(N[n]=t)),i(e,a)},function(){i({},n)})})})}(),{promise:function(){return new Promise(function(e){u("Promise called…"),A.push(e)})}}}e.fetch=n;var o={sendDataToGooglePublisherTag:function(t){window.googletag=window.googletag||{cmd:[]},window.googletag.cmd.push(function(){Object.keys(t.keyValues).forEach(function(e){window.googletag.pubads().setTargeting(e,t.keyValues[e])})})}};e.utils=o;o={moduleName:C,packageName:T,packageVersion:R,fetchCache:N,fetchStateInitial:t,fetchStateRunning:E,fetchStateReady:O,fetchStateFailed:_,fetchStatus:D,fetch:n,utils:o};e.default=o});