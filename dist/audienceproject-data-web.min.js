!function(e,t){"function"==typeof define&&define.amd?define("AudienceProjectData",["exports"],t):"undefined"!=typeof exports?t(exports):(t(t={}),e.AudienceProjectData=t)}("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:this,function(e){"use strict";function P(){return(P=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n,o=arguments[t];for(n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])}return e}).apply(this,arguments)}e.__esModule=!0,e.utils=e.packageVersion=e.packageName=e.moduleName=e.fetchStatus=e.fetchStateRunning=e.fetchStateReady=e.fetchStateInitial=e.fetchStateFailed=e.fetchCache=e.fetch=e.default=void 0;var C="AudienceProjectData";e.moduleName=C;var T="@audienceproject/data-web";e.packageName=T;var R="1.3.1";e.packageVersion=R;var N={};e.fetchCache=N;var t="INITIAL";e.fetchStateInitial=t;var O="RUNNING";e.fetchStateRunning=O;var E="READY";e.fetchStateReady=E;var _="FAILED";e.fetchStateFailed=_;var I={state:t};e.fetchStatus=I;function n(a,e,t){if("string"!=typeof a||!a)throw new Error("Invalid customer ID");var n,o,u=P({allowStorageAccess:!0,allowPersonalisation:!0,gdprApplies:null,consentString:"",integrateWithCmp:!1,waitForCmpConsent:!1,requestParams:{},timeout:1e3,addStatusKey:!1,cacheType:"",cacheKey:"url,allowPersonalisation,requestParams",cacheTime:86400,requestDomains:{regular:"pdw-usr.userreport.com",nonPersonalised:"dnt-userreport.com"},debug:!1},e,(o="__audienceProjectDataFetchOptions=",window.location.search.split(/[?&]/).some(function(e){var t=0===e.indexOf(o);if(t){e=e.slice(o.length);try{n=JSON.parse(decodeURIComponent(e))}catch(e){}}return t}),n)),l=function(){for(var e,t=arguments.length,n=new Array(t),o=0;o<t;o++)n[o]=arguments[o];return u.debug&&(null==(e=console)?void 0:e.log.apply(e,["["+C+"]"].concat(n)))};function r(e){try{return JSON.parse(e)}catch(e){return}}function d(e,t){l("Reading prediction from API…");var i=["med",window.location.href];document.referrer&&i.push("ref",document.referrer);var n=m(h);n&&i.push("sref",n),!u.allowPersonalisation||(n=m(c))&&i.push("dsu",n),"boolean"==typeof u.gdprApplies&&i.push("gdpr",Number(u.gdprApplies)),u.consentString&&i.push("gdpr_consent",u.consentString),i.push("appid",T+":"+R),function o(a,r){Object.keys(a).forEach(function(e){var t,n=a[e];void 0!==n&&(t=r+e,"[object Array]"===Object.prototype.toString.call(n)?n.forEach(function(e){i.push(t,e)}):"object"==typeof n?o(n,t+"_"):i.push(t,n))})}(u.requestParams,"");var o="https://"+(u.allowPersonalisation?u.requestDomains.regular:u.requestDomains.nonPersonalised)+"/api/v2/partner/"+encodeURIComponent(a)+"/uid";return i.forEach(function(e,t){o+=(t%2?"=":t?"&":"?")+encodeURIComponent(e)}),s(o,e,t)}l("Fetch called…"),l("Version:",R),l("Customer ID:",a),l("Customer options:",e),l("Fetch options:",u);var f,p=function(){return function(e){for(var t=0,n=e.length,o=0;o<n;o+=1)t=(t<<5)-t+e.charCodeAt(o),t&=t;return t}(u.cacheKey.split(/\s*,\s*/).sort().map(function(e){if("url"===e)return window.location.pathname.slice(1)+window.location.search;if("allowPersonalisation"===e)return u.allowPersonalisation?"":0;if("requestParams"!==e)return"";e=JSON.stringify(u.requestParams);return"{}"===e?"":e}).join(""))},i=localStorage,h="apr_sref",g="apr_data_cache",c="apr_dsu",m=function(e){if(u.allowStorageAccess){var t;try{t=i[e]}catch(e){}return t&&0===t.indexOf("{")&&t.lastIndexOf("}")===t.length-1?r(t):t}},v=function(e,t){if(u.allowStorageAccess){t="object"==typeof t?JSON.stringify(t):t;try{i[e]=t}catch(e){}}},w=Math.round((new Date).getTime()/1e3),y=function(){return"localStorage"!==u.cacheType||function(){if(!u.allowStorageAccess)return!1;var e="apr_check_access@"+Math.random();try{i[e]=e;var t=i[e]===e;return delete i[e],t}catch(e){}return!1}()?u.cacheType:"memory"},S=new XMLHttpRequest,s=function(e,t,n){l("API request:",e),S.onreadystatechange=function(){var e;S.readyState===XMLHttpRequest.DONE&&(200===S.status?(e=r(S.responseText),l("API response:",e),t(e)):(l("API failed with code:",S.status),n()))},S.open("GET",e,!0),S.withCredentials=u.allowPersonalisation,S.send()},A=[];return"function"==typeof t&&A.push(t),function(){var r;I.state=O,delete I.result,delete I.options;function i(e,t){var n,o,a;s||(s=!0,n=e,o=t.code,u.addStatusKey&&(l("Updating status fields…"),n.keyValues=n.keyValues||{},n.keyValues.ap_ds=String(o)),a=P({type:t.value},e),I.state=0<parseInt(t.code,10)?E:_,I.result=a,I.options=u,function(e){clearTimeout(e);e=(new Date).getTime()-f;l("Timeout ended:",e,"ms")}(r),S.abort(),l("Callback result:",a),A.forEach(function(e){e(a)}))}var n,c,o,a,t,s=!1;n=function(){var e,t={value:"TIMEOUT",code:-2},n={value:"BACKEND_ERROR",code:-1},a=u.allowPersonalisation?{value:"RETURNED",code:1}:{value:"RETURNED_ANONYMOUS",code:"1a"},o=u.allowPersonalisation?{value:"RETURNED_FROM_CACHE",code:2}:{value:"RETURNED_ANONYMOUS_FROM_CACHE",code:"2a"};return r=function(e){if(u.timeout)return l("Timeout started…"),f=(new Date).getTime(),setTimeout(e,u.timeout)}(function(){i({},t)}),u.allowPersonalisation&&(l("Checking session referrer…"),e=window.location.protocol+"//"+window.location.host+"/",document.referrer&&0!==document.referrer.indexOf(e)&&(l("Session referrer updated:",document.referrer),v(h,document.referrer))),function(e,t){var n,o=y();if(!o)return t();l("Reading prediction from cache…");var a=p();return"localStorage"===o?(l("Reading prediction from local storage key:",a),n=m(g)):"memory"===o&&(l("Reading prediction from memory key:",a),n=N[a]),"object"!=typeof n?t():n.ttl+u.cacheTime<w||n.hash!==a?(l("Cached prediction expired…"),t()):(l("Cached prediction:",n.data),e(n.data))}(function(e){i(e,o)},function(){return d(function(e){var t,n,o;t=e,(o=y())&&(l("Saving prediction to cache…"),n=p(),t={data:t,ttl:w,hash:n},"localStorage"===o?v(g,t):"memory"===o&&(N[n]=t)),i(e,a)},function(){i({},n)})})},u.integrateWithCmp?(l("Checking CMP…"),"function"==typeof __tcfapi?(l("Using TCF 2.0 API…"),c=394,o=function(e){var t,n,o,a;u.gdprApplies=Boolean(e.gdprApplies),u.consentString=e.tcString||"",u.gdprApplies&&(a=null==(a=e.vendor)||null==(t=a.consents)?void 0:t[c],u.allowStorageAccess=Boolean(a&&(null==(t=e.purpose)||null==(n=t.consents)?void 0:n[1])),u.allowPersonalisation=Boolean(a&&(null==(e=e.purpose)||null==(o=e.consents)?void 0:o[3]))),l("Options after CMP override:",u)},t=function e(t){"tcloaded"!==t.eventStatus&&"useractioncomplete"!==t.eventStatus||(a("removeEventListener",e),o(t),n())},(a=function(e,o){__tcfapi(e,2,function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];l.apply(void 0,["TCF response:"].concat(t)),o.apply(void 0,t)},[c])})("getTCData",function(e){if(!u.waitForCmpConsent||!e.gdprApplies||"tcloaded"===e.eventStatus||"useractioncomplete"===e.eventStatus)return o(e),void n();l("Adding TCF consent listener…"),a("addEventListener",t)})):l("No TCF 2.0 API found…")):n()}(),{promise:function(){return new Promise(function(e){l("Promise called…"),A.push(e)})}}}e.fetch=n;var o={sendDataToGooglePublisherTag:function(t){window.googletag=window.googletag||{cmd:[]};function e(){Object.keys(t.keyValues).forEach(function(e){window.googletag.pubads().setTargeting(e,t.keyValues[e])})}window.googletag.cmd.unshift?window.googletag.cmd.unshift(e):window.googletag.cmd.push(e)}};e.utils=o;o={moduleName:C,packageName:T,packageVersion:R,fetchCache:N,fetchStateInitial:t,fetchStateRunning:O,fetchStateReady:E,fetchStateFailed:_,fetchStatus:I,fetch:n,utils:o};e.default=o});