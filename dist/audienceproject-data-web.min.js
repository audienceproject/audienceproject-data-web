!function(e,t){"function"==typeof define&&define.amd?define("AudienceProjectData",["exports"],t):"undefined"!=typeof exports?t(exports):(t(t={}),e.AudienceProjectData=t)}("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:this,function(e){"use strict";function C(){return(C=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,r=arguments[t];for(n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}e.__esModule=!0,e.default=e.fetch=e.fetchStatus=e.fetchStateFailed=e.fetchStateReady=e.fetchStateRunning=e.fetchStateInitial=e.fetchCache=e.packageVersion=e.packageName=e.moduleName=void 0;var a="AudienceProjectData";e.moduleName=a;var P="@audienceproject/data-web";e.packageName=P;var R="1.0.2";e.packageVersion=R;var T={};e.fetchCache=T;var t="INITIAL";e.fetchStateInitial=t;var n="RUNNING";e.fetchStateRunning=n;var N="READY";e.fetchStateReady=N;var E="FAILED";e.fetchStateFailed=E;var _={state:t};e.fetchStatus=_;var r=function(c,e,t){if("string"!=typeof c||!c)throw new Error("Invalid customer ID");function s(){for(var e,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return u.debug&&(null==(e=console)?void 0:e.log.apply(e,["["+a+"]"].concat(n)))}var u=C({allowStorageAccess:!0,allowPersonalisation:!0,gdprApplies:null,consentString:"",integrateWithCmp:!1,waitForCmpConsent:!1,requestParams:{},timeout:1e3,addStatusKey:!1,cacheType:"",cacheKey:"url,allowPersonalisation,requestParams",cacheTime:86400,requestDomains:{regular:"pdw-usr.userreport.com",nonPersonalised:"dnt-userreport.com"},debug:!1},e);s("Fetch called…"),s("Version:",R),s("Customer ID:",c),s("Customer options:",e),s("Fetch options:",u);function l(e){try{return JSON.parse(e)}catch(e){return}}function d(){return function(e){for(var t=0,n=e.length,r=0;r<n;r+=1)t=(t<<5)-t+e.charCodeAt(r),t&=t;return t}(u.cacheKey.split(/\s*,\s*/).sort().map(function(e){if("url"===e)return window.location.pathname.slice(1)+window.location.search;if("allowPersonalisation"===e)return u.allowPersonalisation?"":0;if("requestParams"!==e)return"";e=JSON.stringify(u.requestParams);return"{}"===e?"":e}).join(""))}function f(e){if(u.allowStorageAccess){var t;try{t=r[e]}catch(e){}return t&&0===t.indexOf("{")&&t.lastIndexOf("}")===t.length-1?l(t):t}}function p(e,t){if(u.allowStorageAccess){var n="object"==typeof t?JSON.stringify(t):t;try{r[e]=n}catch(e){}}}function h(){return"localStorage"!==u.cacheType||function(){if(!u.allowStorageAccess)return!1;var e="apr_check_access@"+Math.random();try{r[e]=e;var t=r[e]===e;return delete r[e],t}catch(e){}return!1}()?u.cacheType:"memory"}function g(e,t){s("Reading prediction from API…");var i=["med",window.location.href];document.referrer&&i.push("ref",document.referrer);var n=f(v);n&&i.push("sref",n),!u.allowPersonalisation||(n=f("apr_dsu"))&&i.push("dsu",n),"boolean"==typeof u.gdprApplies&&i.push("gdpr",Number(u.gdprApplies)),u.consentString&&i.push("gdpr_consent",u.consentString),i.push("appid",P+":"+R),function r(a,o){Object.keys(a).forEach(function(e){var t=a[e],n=o+e;e=t,"[object Array]"===Object.prototype.toString.call(e)?t.forEach(function(e){i.push(n,e)}):"object"==typeof t?r(t,n+"_"):i.push(n,t)})}(u.requestParams,"");var r,a,o="https://"+(u.allowPersonalisation?u.requestDomains.regular:u.requestDomains.nonPersonalised)+"/api/v2/partner/"+encodeURIComponent(c)+"/uid";return i.forEach(function(e,t){o+=(t%2?"=":t?"&":"?")+encodeURIComponent(e)}),r=e,a=t,s("API request:",t=o),w.onreadystatechange=function(){var e;w.readyState===XMLHttpRequest.DONE&&(200===w.status?(e=l(w.responseText),s("API response:",e),r(e)):(s("API failed with code:",w.status),a()))},w.open("GET",t,!0),w.withCredentials=u.allowPersonalisation,void w.send()}var m,r=localStorage,v="apr_sref",y="apr_data_cache",S=Math.round((new Date).getTime()/1e3),w=new XMLHttpRequest,A=[];return"function"==typeof t&&A.push(t),function(){var o;function i(e,t){var n,r,a;c||(c=!0,n=e,r=t.code,u.addStatusKey&&(s("Updating status fields…"),n.keyValues=n.keyValues||{},n.keyValues.ap_ds=String(r)),a=C({type:t.value},e),_.state=0<t.code?N:E,_.result=a,_.options=u,t=o,clearTimeout(t),t=(new Date).getTime()-m,s("Timeout ended:",t,"ms"),w.abort(),s("Callback result:",a),A.forEach(function(e){e(a)}))}_.state=n,delete _.result,delete _.options;var c=!1;!function(n){if(u.integrateWithCmp){if(s("Checking CMP…"),"function"!=typeof __tcfapi)return s("No TCF 2.0 API found…"),n();s("Using TCF 2.0 API…");var r=function(e){var t,n,r,a;u.gdprApplies=Boolean(e.gdprApplies),u.consentString=e.tcString||"",u.gdprApplies&&(a=null==(a=e.vendor)||null==(t=a.consents)?void 0:t[394],u.allowStorageAccess=Boolean(a&&(null==(t=e.purpose)||null==(n=t.consents)?void 0:n[1])),u.allowPersonalisation=Boolean(a&&(null==(e=e.purpose)||null==(r=e.consents)?void 0:r[3]))),s("Options after CMP override:",u)},a=function(e,r){__tcfapi(e,2,function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];s.apply(void 0,["TCF response:"].concat(t)),r.apply(void 0,t)},[394])},t=function e(t){t.tcString&&(a("removeEventListener",e),r(t),n())};a("getTCData",function(e){if(!u.waitForCmpConsent||!e.gdprApplies||e.tcString)return r(e),void n();s("Adding TCF consent listener…"),a("addEventListener",t)})}else n()}(function(){var e,t={value:"TIMEOUT",code:-2},n={value:"BACKEND_ERROR",code:-1},a=u.allowPersonalisation?{value:"RETURNED",code:1}:{value:"RETURNED_ANONYMOUS",code:"1a"},r=u.allowPersonalisation?{value:"RETURNED_FROM_CACHE",code:2}:{value:"RETURNED_ANONYMOUS_FROM_CACHE",code:"2a"};return o=function(e){if(u.timeout)return s("Timeout started…"),m=(new Date).getTime(),setTimeout(e,u.timeout)}(function(){i({},t)}),u.allowPersonalisation&&(s("Checking session referrer…"),e=window.location.protocol+"//"+window.location.host+"/",document.referrer&&0!==document.referrer.indexOf(e)&&(s("Session referrer updated:",document.referrer),p(v,document.referrer))),function(e,t){var n,r=h();if(!r)return t();s("Reading prediction from cache…");var a=d();return"localStorage"===r?(s("Reading prediction from local storage key:",a),n=f(y)):"memory"===r&&(s("Reading prediction from memory key:",a),n=T[a]),"object"!=typeof n?t():n.ttl+u.cacheTime<S||n.hash!==a?(s("Cached prediction expired…"),t()):(s("Cached prediction:",n.data),e(n.data))}(function(e){i(e,r)},function(){return g(function(e){var t,n,r;t=e,(r=h())&&(s("Saving prediction to cache…"),n=d(),t={data:t,ttl:S,hash:n},"localStorage"===r?p(y,t):"memory"===r&&(T[n]=t)),i(e,a)},function(){i({},n)})})})}(),{promise:function(){return new Promise(function(e){s("Promise called…"),A.push(e)})}}};e.fetch=r;r={moduleName:a,packageName:P,packageVersion:R,fetchCache:T,fetchStateInitial:t,fetchStateRunning:n,fetchStateReady:N,fetchStateFailed:E,fetchStatus:_,fetch:r};e.default=r});