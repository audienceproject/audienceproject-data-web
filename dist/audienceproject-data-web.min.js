!function(e,t){"function"==typeof define&&define.amd?define("AudienceProjectData",["exports"],t):"undefined"!=typeof exports?t(exports):(t(t={}),e.AudienceProjectData=t)}("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:this,function(e){"use strict";function C(){return(C=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,a=arguments[t];for(n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}e.__esModule=!0,e.default=e.fetch=e.fetchStatus=e.fetchStateFailed=e.fetchStateReady=e.fetchStateRunning=e.fetchStateInitial=e.fetchCache=e.packageVersion=e.packageName=e.moduleName=void 0;var P="AudienceProjectData";e.moduleName=P;var R="@audienceproject/data-web";e.packageName=R;var T="1.1.0";e.packageVersion=T;var N={};e.fetchCache=N;var t="INITIAL";e.fetchStateInitial=t;var E="RUNNING";e.fetchStateRunning=E;var O="READY";e.fetchStateReady=O;var _="FAILED";e.fetchStateFailed=_;var I={state:t};e.fetchStatus=I;var n=function(o,e,t){if("string"!=typeof o||!o)throw new Error("Invalid customer ID");var n,a,s=C({allowStorageAccess:!0,allowPersonalisation:!0,gdprApplies:null,consentString:"",integrateWithCmp:!1,waitForCmpConsent:!1,requestParams:{},timeout:1e3,addStatusKey:!1,cacheType:"",cacheKey:"url,allowPersonalisation,requestParams",cacheTime:86400,requestDomains:{regular:"pdw-usr.userreport.com",nonPersonalised:"dnt-userreport.com"},debug:!1},e,(a="__audienceProjectDataFetchOptions=",window.location.search.split(/[?&]/).some(function(e){var t=0===e.indexOf(a);if(t){e=e.slice(a.length);try{n=JSON.parse(decodeURIComponent(e))}catch(e){}}return t}),n)),u=function(){for(var e,t=arguments.length,n=new Array(t),a=0;a<t;a++)n[a]=arguments[a];return s.debug&&(null==(e=console)?void 0:e.log.apply(e,["["+P+"]"].concat(n)))};u("Fetch called…"),u("Version:",T),u("Customer ID:",o),u("Customer options:",e),u("Fetch options:",s);function r(e){try{return JSON.parse(e)}catch(e){return}}function l(e,t){u("Reading prediction from API…");var i=["med",window.location.href];document.referrer&&i.push("ref",document.referrer);var n=m(p);n&&i.push("sref",n),!s.allowPersonalisation||(n=m(c))&&i.push("dsu",n),"boolean"==typeof s.gdprApplies&&i.push("gdpr",Number(s.gdprApplies)),s.consentString&&i.push("gdpr_consent",s.consentString),i.push("appid",R+":"+T),function a(o,r){Object.keys(o).forEach(function(e){var t,n=o[e];void 0!==n&&(t=r+e,"[object Array]"===Object.prototype.toString.call(n)?n.forEach(function(e){i.push(t,e)}):"object"==typeof n?a(n,t+"_"):i.push(t,n))})}(s.requestParams,"");var a="https://"+(s.allowPersonalisation?s.requestDomains.regular:s.requestDomains.nonPersonalised)+"/api/v2/partner/"+encodeURIComponent(o)+"/uid";return i.forEach(function(e,t){a+=(t%2?"=":t?"&":"?")+encodeURIComponent(e)}),w(a,e,t)}var d,f=function(){return function(e){for(var t=0,n=e.length,a=0;a<n;a+=1)t=(t<<5)-t+e.charCodeAt(a),t&=t;return t}(s.cacheKey.split(/\s*,\s*/).sort().map(function(e){if("url"===e)return window.location.pathname.slice(1)+window.location.search;if("allowPersonalisation"===e)return s.allowPersonalisation?"":0;if("requestParams"!==e)return"";e=JSON.stringify(s.requestParams);return"{}"===e?"":e}).join(""))},i=localStorage,p="apr_sref",h="apr_data_cache",c="apr_dsu",m=function(e){if(s.allowStorageAccess){var t;try{t=i[e]}catch(e){}return t&&0===t.indexOf("{")&&t.lastIndexOf("}")===t.length-1?r(t):t}},g=function(e,t){if(s.allowStorageAccess){t="object"==typeof t?JSON.stringify(t):t;try{i[e]=t}catch(e){}}},v=Math.round((new Date).getTime()/1e3),y=function(){return"localStorage"!==s.cacheType||function(){if(!s.allowStorageAccess)return!1;var e="apr_check_access@"+Math.random();try{i[e]=e;var t=i[e]===e;return delete i[e],t}catch(e){}return!1}()?s.cacheType:"memory"},S=new XMLHttpRequest,w=function(e,t,n){u("API request:",e),S.onreadystatechange=function(){var e;S.readyState===XMLHttpRequest.DONE&&(200===S.status?(e=r(S.responseText),u("API response:",e),t(e)):(u("API failed with code:",S.status),n()))},S.open("GET",e,!0),S.withCredentials=s.allowPersonalisation,S.send()},A=[];return"function"==typeof t&&A.push(t),function(){var r;I.state=E,delete I.result,delete I.options;function i(e,t){var n,a,o;c||(c=!0,n=e,a=t.code,s.addStatusKey&&(u("Updating status fields…"),n.keyValues=n.keyValues||{},n.keyValues.ap_ds=String(a)),o=C({type:t.value},e),I.state=0<t.code?O:_,I.result=o,I.options=s,function(e){clearTimeout(e);e=(new Date).getTime()-d;u("Timeout ended:",e,"ms")}(r),S.abort(),u("Callback result:",o),A.forEach(function(e){e(o)}))}var c=!1;!function(n){if(s.integrateWithCmp){if(u("Checking CMP…"),"function"!=typeof __tcfapi)return u("No TCF 2.0 API found…"),n();u("Using TCF 2.0 API…");var r=394,a=function(e){var t,n,a,o;s.gdprApplies=Boolean(e.gdprApplies),s.consentString=e.tcString||"",s.gdprApplies&&(o=null==(o=e.vendor)||null==(t=o.consents)?void 0:t[r],s.allowStorageAccess=Boolean(o&&(null==(t=e.purpose)||null==(n=t.consents)?void 0:n[1])),s.allowPersonalisation=Boolean(o&&(null==(e=e.purpose)||null==(a=e.consents)?void 0:a[3]))),u("Options after CMP override:",s)},o=function(e,a){__tcfapi(e,2,function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];u.apply(void 0,["TCF response:"].concat(t)),a.apply(void 0,t)},[r])},t=function e(t){"tcloaded"!==t.eventStatus&&"useractioncomplete"!==t.eventStatus||(o("removeEventListener",e),a(t),n())};o("getTCData",function(e){if(!s.waitForCmpConsent||!e.gdprApplies||"tcloaded"===e.eventStatus||"useractioncomplete"===e.eventStatus)return a(e),void n();u("Adding TCF consent listener…"),o("addEventListener",t)})}else n()}(function(){var e,t={value:"TIMEOUT",code:-2},n={value:"BACKEND_ERROR",code:-1},o=s.allowPersonalisation?{value:"RETURNED",code:1}:{value:"RETURNED_ANONYMOUS",code:"1a"},a=s.allowPersonalisation?{value:"RETURNED_FROM_CACHE",code:2}:{value:"RETURNED_ANONYMOUS_FROM_CACHE",code:"2a"};return r=function(e){if(s.timeout)return u("Timeout started…"),d=(new Date).getTime(),setTimeout(e,s.timeout)}(function(){i({},t)}),s.allowPersonalisation&&(u("Checking session referrer…"),e=window.location.protocol+"//"+window.location.host+"/",document.referrer&&0!==document.referrer.indexOf(e)&&(u("Session referrer updated:",document.referrer),g(p,document.referrer))),function(e,t){var n,a=y();if(!a)return t();u("Reading prediction from cache…");var o=f();return"localStorage"===a?(u("Reading prediction from local storage key:",o),n=m(h)):"memory"===a&&(u("Reading prediction from memory key:",o),n=N[o]),"object"!=typeof n?t():n.ttl+s.cacheTime<v||n.hash!==o?(u("Cached prediction expired…"),t()):(u("Cached prediction:",n.data),e(n.data))}(function(e){i(e,a)},function(){return l(function(e){var t,n,a;t=e,(a=y())&&(u("Saving prediction to cache…"),n=f(),t={data:t,ttl:v,hash:n},"localStorage"===a?g(h,t):"memory"===a&&(N[n]=t)),i(e,o)},function(){i({},n)})})})}(),{promise:function(){return new Promise(function(e){u("Promise called…"),A.push(e)})}}};e.fetch=n;n={moduleName:P,packageName:R,packageVersion:T,fetchCache:N,fetchStateInitial:t,fetchStateRunning:E,fetchStateReady:O,fetchStateFailed:_,fetchStatus:I,fetch:n};e.default=n});